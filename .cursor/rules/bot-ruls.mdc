---
alwaysApply: true
---
ПРОФЕССИОНАЛЬНЫЕ ПРАВИЛА

Цель проекта
Основная задача — разработка Telegram-бота на Python с использованием:
* aiogram — Telegram Bot API
* python-dotenv — управление переменными окружения
* pytest — тестирование
* других библиотек только при необходимости и с разрешения пользователя
Код должен быть пригоден для production-использования и дальнейшего расширения.

Структура проекта Telegram-бота (aiogram)
Проект должен соблюдать примерно такую структуру каталогов и файлов:
.
├─ README.md
├─ requirements.txt
├─ .env
├─ .env.example
├─ src/
│  └─ bot/
│     ├─ __init__.py
│     ├─ __main__.py
│     ├─ main.py
│     ├─ config.py
│     ├─ routers/
│     │  ├─ __init__.py
│     │  ├─ start.py
│     │  ├─ help.py
│     │  └─ echo.py
│     ├─ keyboards/
│     │  ├─ __init__.py
│     │  └─ common.py
│     ├─ services/
│     │  ├─ __init__.py
│     │  └─ text.py
│     └─ utils/
│        ├─ __init__.py
│        └─ logging.py
└─ tests/
   ├─ __init__.py
   └─ test_text_service.py

Правила структуры:
- `main.py` — единственная точка инициализации и запуска бота (polling)
- `routers/` — только Telegram-роутеры и обработчики, без бизнес-логики
- `services/` — бизнес-логика, не зависящая от aiogram и Telegram
- `keyboards/` — создание клавиатур и UI-компонентов
- `config.py` — загрузка `.env` и конфигурации приложения
- `utils/` — вспомогательные функции без бизнес-логики
- `tests/` — unit-тесты сервисного слоя (pytest)

Отклонения от этой структуры допускаются по согласованию с пользователем.

Структура файлов
* Один файл — одна ответственностьФайл должен отвечать за одну логическую область без смешения уровней абстракции.
* Ограничение на размер файлаПредпочтительный размер файла — до 300 строк.
* Осознанные исключенияПревышение лимита допустимо только для:
    * автоматически сгенерированного кода
    * декларативных структур (конфиги, схемы, DTO, enum’ы)

Базовые инженерные принципы
* Архитектура по контексту задачиДля production-кода использовать SOLID и Clean Architecture с чёткими границами и модулями.Для скриптов, прототипов и утилит допустим упрощённый, прагматичный подход.
* Слабая связанность и тестируемостьНе использовать жёсткие зависимости. Внешние зависимости передавать через внедрение зависимостей и абстракции.
* Минимальные и атомарные измененияКаждое изменение должно быть небольшим, локальным и легко откатываемым.
* Без дублированияПеред добавлением нового кода изучить кодовую базу и переиспользовать существующие решения.
* Явное лучше неявногоЗапрещена скрытая логика и неочевидное поведение.

Правила работы с кодовой базой
* Сначала читать и искатьПеред любыми изменениями необходимо прочитать релевантные файлы и проверить, нет ли уже похожей реализации.
* Запрещены предположенияНельзя выдумывать API, поведение или структуру. Если информации недостаточно — задать вопрос.

Качество и стиль кода
* Явная типизация на границах системы: Обязательно типизировать публичные функции, сервисный слой, интеграции, модели данных и ключевые структуры.
* Any, type: ignore, # noqa запрещены по умолчаниюДопускаются только точечно, с обязательным пояснением причины.
* Никаких магических значений: Все константы выносить на уровень модуля сразу после импортов и называть в UPPER_CASE.
* Осмысленные имена: Имена переменных, функций и классов должны быть самодокументируемыми.
* Чистота кодовой базы: Неиспользуемый и устаревший код должен удаляться.
* Корректная обработка ошибок: Использовать конкретные типы исключений с понятными сценариями отказа.
* Безопасность: Запрещено добавлять в код логи или промпты токены, ключи, секреты и персональные данные.

Зависимости и окружение
* Все зависимости фиксируются в requirements.txtЛюбое добавление, обновление или удаление библиотеки требует обновления файла.
* Изменения зависимостей — только с разрешения пользователяЗапрещено добавлять, обновлять или удалять библиотеки без явного согласования.
* Никаких неявных зависимостейНельзя полагаться на глобально установленные пакеты.
* Работа только в виртуальном окружении проектаВсе установки и запуски выполнять в виртуальном окружении, созданном в текущей папке (.venv/).
* Обоснование новых зависимостейПри предложении библиотеки необходимо указать цель и область использования.

Критические ограничения (НАРУШАТЬ ЗАПРЕЩЕНО)
* Git запрещён без прямого запроса пользователяНельзя создавать коммиты, ветки, выполнять push или pull.
* Никогда не запускать миграции
* Изменения базы данных только после согласованияЛюбые правки моделей, схемы или миграций требуют предварительного одобрения.

Документация
* Основная документация хранится в README.md
* Не создавать произвольные .md файлы без необходимости
* Документация должна содержать:
    * инструкции по запуску
    * переменные окружения с примерами
    * runbook’и для деплоя, отката и диагностики
* Комментарии и документация проекта - на русском языке

Порядок разработки (Workflow):
1) План. Сначала предложи 2 варианта изменений, выбери лучший и объясни, почему. Задавай вопросы, если что-то непонятно.
2) Изменения. Внеси одобренные изменения. Используй MCP сервер Context7 для проверки документации
3) Тесты. Протестируй работу программы с помощью тестов, исправь ошибки в коде или в тестах
4) Ревью. Проведи итоговое ревью. Ты архитектор ПО, обращай внимание на недочеты в архитектуре. Делай код расширяемым, используй SOLID.